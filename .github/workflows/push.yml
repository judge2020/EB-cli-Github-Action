name: Docker Image CD

on: push

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: Build the Docker image
        run: docker build . --tag eb:latest
      - name: Login to GitHub Package Repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
          docker login docker.pkg.github.com -u literallyanything -p ${GH_TOKEN}
      - name: Tag and push date
        run: |
          export DATE_TAG=$(date +%s)
          docker tag eb:latest docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${DATE_TAG}
          docker push docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${DATE_TAG}
      - name: Tag and push branch name
        run: |
          docker tag eb:latest docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${GITHUB_REF/refs\/heads\//} || echo "failsafe for non-conforming branch names"
          docker push docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${GITHUB_REF/refs\/heads\//} || echo "failsafe for non-conforming branch names"
      - name: Tag and push SHA
        run: |
          echo ${GITHUB_SHA}
          docker tag eb:latest docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${GITHUB_SHA}
          docker push docker.pkg.github.com/judge2020/eb-cli-github-action/eb:${GITHUB_SHA}
